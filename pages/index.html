<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is Corona Spreading?</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>

    <style>
        body {
            font-family: 'Source Sans Pro', sans-serif;
        }

        h2 {
            font-weight: bold;
        }

        .chart {
            max-width: 45rem;
        }

        select {
            max-width: 15rem;
            min-width: 15rem;
        }

        input[type="number"] {
            -webkit-appearance: textfield;
               -moz-appearance: textfield;
                    appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- trend chart -->
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="mt-3">Is Corona Spreading?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="trend_chart_mode" value="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="trend_chart_mode" value="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="trend_chart" class="chart mx-auto mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-3">
                <h5>Region</h5>
                <select id="trend_chart_region" class="form-control"></select>
            </div>
            <div class="col-3">
                <h5>Case Type</h5>
                <select id="trend_chart_case_type" class="form-control">
                    <option value="confirmed">confirmed</option>
                    <option value="death">death</option>
                    <option value="recovered">recovered</option>
                </select>
            </div>
            <div class="col-3">
                <h5>Curve Fitting</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="trend_chart_curve_fitting" id="sigmoidal" value="sigmoidal">
                    <label class="form-check-label" for="sigmoidal">
                        sigmoidal
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="trend_chart_curve_fitting" id="exponential" value="exponential" checked>
                    <label class="form-check-label" for="exponential">
                        exponential
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="trend_chart_curve_fitting" id="linear" value="linear">
                    <label class="form-check-label" for="linear">
                        linear
                    </label>
                </div>
            </div>
            <div class="col-3">
                <h5>Prediction Points</h5>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <button class="btn btn-secondary" type="button" id="button-addon1" onclick="
                            trend_chart_prediction_point.stepDown();
                            trend_chart_prediction_point.dispatchEvent(new Event('change'));
                        "><b>âˆ’</b></button>
                    </div>
                    <input type="number" class="form-control text-center" min="0" value="2" style="max-width: 5rem" id="trend_chart_prediction_point">
                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="button" id="button-addon2" onclick="
                            trend_chart_prediction_point.stepUp();
                            trend_chart_prediction_point.dispatchEvent(new Event('change'));
                        "><b>+</b></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- death-to-recovery chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">What is the death-to-recovery ratio?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="death_to_recovery_chart_mode" value="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="death_to_recovery_chart_mode" value="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="death_to_recovery_chart" class="chart mx-auto mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12 d-flex justify-content-center">
                <div>
                    <h5>Region</h5>
                    <select name="" id="death_to_recovery_chart_region" class="form-control"></select>
                </div>
            </div>
        </div>

        <!-- region-comparison chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">How do these regions compare?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="region_comparison_chart_mode" value="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="region_comparison_chart_mode" value="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="region_comparison_chart" class="chart mx-auto mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-4">
                <h5>Region 1</h5>
                <select id="region_comparison_chart_region_1" class="form-control"></select>
            </div>
            <div class="col-4">
                <h5>Region 2</h5>
                <select id="region_comparison_chart_region_2" class="form-control"></select>
            </div>
            <div class="col-4">
                <h5>Region 3</h5>
                <select id="region_comparison_chart_region_3" class="form-control"></select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12 d-flex justify-content-center">
                <div>
                    <h5>Case Type</h5>
                    <select id="region_comparison_chart_case_type" class="form-control">
                        <option value="confirmed" selected>comfirmed</option>
                        <option value="death">death</option>
                        <option value="recovered">recovered</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- percentage chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">How many of them are from China?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="percentage_chart_mode" value="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="percentage_chart_mode" value="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="percentage_chart" class="chart mx-auto mt-3"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script src="data.js"></script>
    <script>
        data.dates = data.dates.map(date => date.slice(5));
        ///////////// helper functions /////////////////////////////////////
        
        function delta(array) {
            let result = [];
            for (let i = 0; i < array.length - 1; i++) {
                result[i] = array[i+1] - array[i];
            }
            return result;
        }

        ///////////// populate region drop-down lists /////////////////////////////////////

        let optionString = "";
        for (const region in data.counts) {
            optionString += `<option value="${region}">${region}</option>`;
        }

        $("#trend_chart_region").append(optionString);
        $("#death_to_recovery_chart_region").append(optionString);
        $("#region_comparison_chart_region_1").append(optionString);
        $("#region_comparison_chart_region_2").append(optionString);
        $("#region_comparison_chart_region_3").append(optionString);

        ///////////// trend_chart /////////////////////////////////////

        // onload:
        let trendChart = drawTrendChart();

        // on "new case"/"cumulative" clicked:
        $("input[name='trend_chart_mode']").on("click", function() {
            trendChart.destroy();
            trendChart = drawTrendChart();
        });

        // on region or case type selected:
        $("#trend_chart_region, #trend_chart_case_type, input[name='trend_chart_curve_fitting'], #trend_chart_prediction_point").on("change", function() {
            trendChart.destroy();
            trendChart = drawTrendChart();
        });

        
        function drawTrendChart() {
            
            let region = $("#trend_chart_region").val();
            let caseType = $("#trend_chart_case_type").val();
            let curveFitting = $("input[name='trend_chart_curve_fitting']:checked").val();
            let predictionPoint = $("#trend_chart_prediction_point").val();
            let mode = $("input[name='trend_chart_mode']:checked").val();
            let timeSeries = getTimeSeriesForTrendChart(region, caseType, curveFitting, predictionPoint, mode);

            let context = $("#trend_chart")[0].getContext("2d");

            return new Chart(context, { 
                type: "line", 
                data: {
                    labels: timeSeries.time,
                    datasets: [{
                        label: region,
                        backgroundColor: "#f44336",
                        borderColor: "#f44336",
                        pointRadius: 5,
                        pointHoverRadius: 10,
                        showLine: false,
                        data: timeSeries.region
                    }, {
                        label: curveFitting,
                        borderColor: "#888888",
                        pointRadius: 0,
                        borderDash: [5,5],
                        fill: false,
                        data: timeSeries.curve
                    }]
                }, 
                options: {
                    legend: {position: "bottom"},
                    aspectRatio: 1.2,
                    scales: {
                        xAxes: [{
                            scaleLabel: {display: true, labelString: "Date"}
                        }],
                        yAxes: [{
                            ticks: {min: 0},
                            scaleLabel: {display: true, labelString: "Number of Person"}
                        }]
                    },
                    animation: {duration: 0}
                }
            });
        }

        function getTimeSeriesForTrendChart(region, caseType, curveFitting, predictionPoint, mode) {
            if (mode !== "new_case" && mode !== "cumulative") {
                throw "The mode requested is neither new_case nor cumulative.";
            }

            if (caseType !== "confirmed" && caseType !== "recovered" && caseType !== "death") {
                throw "The caseType requested is neither confirmed, recovered nor death.";
            }

            let timeSeries = {};
            timeSeries.time = data.dates.slice();
            timeSeries.region = data.counts[region][caseType].slice();
            // TODO: what if the region / case type is not found?

            if (mode === "new_case") {
                timeSeries.time = timeSeries.time.slice(1);  // remove first value
                timeSeries.region = delta(timeSeries.region);
            }

            // curveFitting
            let input = timeSeries.region.map((value, index) => [index, value]);  //make an array of [x,y] pairs
            // const output = regression.exponential(input);
            let output = regression[curveFitting](input);
            timeSeries.curve = output.points.map(pair => pair[1]);

            //predictionPoints
            for (let i = 0; i < predictionPoint; i++) {
                timeSeries.time.push(`+ ${i+1}`);
                timeSeries.curve.push( output.predict(output.points.length + i)[1] );
            }

            return timeSeries;
        }

        ///////////// death_to_recovery_chart /////////////////////////////////////

        // onload:
        let deathToRecoveryChart = drawDeathToRecoveryChart();

        // on "new case"/"cumulative" clicked:
        $("input[name='death_to_recovery_chart_mode']").on("click", function() {
            deathToRecoveryChart.destroy();
            deathToRecoveryChart = drawDeathToRecoveryChart();
        });

        // on region selected:
        $("#death_to_recovery_chart_region").on("change", function() {
            deathToRecoveryChart.destroy();
            deathToRecoveryChart = drawDeathToRecoveryChart();
        });


        function drawDeathToRecoveryChart() {
            
            let region = $("#death_to_recovery_chart_region").val();
            let mode = $("input[name='death_to_recovery_chart_mode']:checked").val();
            let timeSeries = getTimeSeriesForDeathToRecoveryChart(region, mode);

            let context = $("#death_to_recovery_chart")[0].getContext("2d");

            return new Chart(context, { 
                type: "line", 
                data: {
                    labels: timeSeries.time,
                    datasets: [{
                        label: "recovered",
                        backgroundColor: "#64dd17",
                        borderColor: "#64dd17",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.recovered
                    }, {
                        label: "death",
                        backgroundColor: "#424242",
                        borderColor: "#424242",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.death
                    }, {
                        label: "confirmed",
                        backgroundColor: "#f44336",
                        borderColor: "#f44336",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.confirmed,
                        hidden: true
                    }]
                }, 
                options: {
                    legend: {position: "bottom"},
                    aspectRatio: 1.2,
                    scales: {
                        xAxes: [{
                            scaleLabel: {display: true, labelString: "Date"}
                        }],
                        yAxes: [{
                            ticks: {min: 0},
                            scaleLabel: {display: true, labelString: "Number of Person"}
                        }]
                    },
                }
            });
        }

        function getTimeSeriesForDeathToRecoveryChart(region, mode) {
            if (mode !== "new_case" && mode !== "cumulative") {
                throw "The mode requested is neither new_case nor cumulative.";
            }

            let timeSeries = {};
            timeSeries.time = data.dates.slice();
            timeSeries.confirmed = data.counts[region]["confirmed"].slice();
            timeSeries.recovered = data.counts[region]["recovered"].slice();
            timeSeries.death = data.counts[region]["death"].slice();
            // TODO: what if the region / case type is not found?

            if (mode === "new_case") {
                timeSeries.time = timeSeries.time.slice(1);  // remove first value
                timeSeries.confirmed = delta(timeSeries.confirmed);
                timeSeries.recovered = delta(timeSeries.recovered);
                timeSeries.death = delta(timeSeries.death);
            }

            return timeSeries;
        }

        ///////////// region_comparison_chart /////////////////////////////////////

        // onload:
        let regionComparisonChart = drawRegionComparisonChart();

        // on "new case"/"cumulative" clicked:
        $("input[name='region_comparison_chart_mode']").on("click", function() {
            regionComparisonChart.destroy();
            regionComparisonChart = drawRegionComparisonChart();
        });

        // on region or case type selected:
        $("#region_comparison_chart_region_1, #region_comparison_chart_region_2, #region_comparison_chart_region_3, #region_comparison_chart_case_type").on("change", function() {
            regionComparisonChart.destroy();
            regionComparisonChart = drawRegionComparisonChart();
        });


        function drawRegionComparisonChart() {
            
            let region1 = $("#region_comparison_chart_region_1").val();
            let region2 = $("#region_comparison_chart_region_2").val();
            let region3 = $("#region_comparison_chart_region_3").val();
            let caseType = $("#region_comparison_chart_case_type").val();
            let mode = $("input[name='region_comparison_chart_mode']:checked").val();
            let timeSeries = getTimeSeriesForRegionComparisonChart(region1, region2, region3, caseType, mode);

            let context = $("#region_comparison_chart")[0].getContext("2d");

            return new Chart(context, { 
                type: "line", 
                data: {
                    labels: timeSeries.time,
                    datasets: [{
                        label: region1,
                        backgroundColor: "#11617a",
                        borderColor: "#11617a",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.region1
                    }, {
                        label: region2,
                        backgroundColor: "#09baa0",
                        borderColor: "#09baa0",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.region2
                    }, {
                        label: region3,
                        backgroundColor: "#ffb45e",
                        borderColor: "#ffb45e",
                        fill: false,
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.region3
                    }]
                }, 
                options: {
                    legend: { position: "bottom" },
                    aspectRatio: 1.2,
                    scales: {
                        xAxes: [{
                            scaleLabel: {display: true, labelString: "Date"}
                        }],
                        yAxes: [{
                            ticks: {min: 0},
                            scaleLabel: {display: true, labelString: "Number of Person"}
                        }]
                    },
                }
            });
        }

        function getTimeSeriesForRegionComparisonChart(region1, region2, region3, caseType, mode) {
            if (mode !== "new_case" && mode !== "cumulative") {
                throw "The mode requested is neither new_case nor cumulative.";
            }

            if (caseType !== "confirmed" && caseType !== "recovered" &&  caseType !== "death") {
                throw "The caseType requested is neither confirmed, recovered nor death.";
            }

            let timeSeries = {};
            timeSeries.time = data.dates.slice();
            timeSeries.region1 = data.counts[region1][caseType].slice();
            timeSeries.region2 = data.counts[region2][caseType].slice();
            timeSeries.region3 = data.counts[region3][caseType].slice();
            // TODO: what if the region / case type is not found?

            if (mode === "new_case") {
                timeSeries.time = timeSeries.time.slice(1);  // remove first value
                timeSeries.region1 = delta(timeSeries.region1);
                timeSeries.region2 = delta(timeSeries.region2);
                timeSeries.region3 = delta(timeSeries.region3);
            }

            return timeSeries;
        }

        ///////////// percentage_chart /////////////////////////////////////

        // onload:
        let percentageChart = drawPercentageChart();

        // on "new case"/"cumulative" clicked:
        $("input[name='percentage_chart_mode']").on("click", function() {
            percentageChart.destroy();
            percentageChart = drawPercentageChart();
        });


        function drawPercentageChart() {

            let mode = $("input[name='percentage_chart_mode']:checked").val();
            let timeSeries = getTimeSeriesForPercentageChart(mode);

            let context = $("#percentage_chart")[0].getContext("2d");

            return new Chart(context, { 
                type: "line", 
                data: {
                    labels: timeSeries.time,
                    datasets: [{
                        label: "China (Mainland)",
                        backgroundColor: "#df2407",
                        borderColor: "#df2407",
                        cubicInterpolationMode: "monotone",
                        data: timeSeries.chinaPercentage
                    }]
                }, 
                options: {
                    legend: { position: "bottom" },
                    aspectRatio: 1.2,
                    scales: {
                        xAxes: [{
                            scaleLabel: {display: true, labelString: "Date"}
                        }],
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 1,
                                callback: function (value) {
                                    return (value * 100).toFixed(0) + "%";  // show tick label as percentages
                                }
                            }
                        }]
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                return (tooltipItem.yLabel * 100).toFixed(1) + "%";  // show tooltip label as percentages
                            }
                        }
                    }
                }
            });
        }

        function getTimeSeriesForPercentageChart(mode) {
            if (mode !== "new_case" && mode !== "cumulative") {
                throw "The mode requested is neither new_case nor cumulative.";
            }

            let timeSeries = {};
            timeSeries.time = data.dates.slice();
            timeSeries.china = data.counts["Mainland China"]["confirmed"].slice();
            timeSeries.world = data.counts["World"]["confirmed"].slice();
            // TODO: what if the region / case type is not found?

            if (mode === "new_case") {
                timeSeries.time = timeSeries.time.slice(1);  // remove first value
                timeSeries.china = delta(timeSeries.china);
                timeSeries.world = delta(timeSeries.world);
            }

            timeSeries.chinaPercentage = [];
            for (let i = 0; i < timeSeries.china.length; i++) {
                timeSeries.chinaPercentage[i] = timeSeries.china[i] / timeSeries.world[i];
            }       

            return timeSeries;
        }

    </script>
</body>

</html>