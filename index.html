<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is Corona Spreading?</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>

    <style>
        h2 {
            font-weight: bold;
        }

        select {
            max-width: 15rem;
            min-width: 15rem;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- trend chart -->
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="mt-3">Is Corona Spreading?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="mode" id="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="mode" id="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="trend_chart" class="px-5 mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-3">
                <h5>Region</h5>
                <select name="" id="" class="form-control">
                    <option value="china">China</option>
                    <option value="macau">Macau</option>
                    <option value="hong_kong">Hong Kong</option>
                    <option value="taiwan">Taiwan</option>
                </select>
            </div>
            <div class="col-3">
                <h5>Case Type</h5>
                <select name="" id="" class="form-control">
                    <option value="1">comfirmed</option>
                    <option value="2">suspected</option>
                    <option value="3">dead</option>
                    <option value="4">recovered</option>
                </select>
            </div>
            <div class="col-3">
                <h5>Curve Fitting</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" checked>
                    <label class="form-check-label" for="exampleRadios1">
                        Sigmoidal
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2">
                    <label class="form-check-label" for="exampleRadios2">
                        Exponential
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3" value="option3">
                    <label class="form-check-label" for="exampleRadios3">
                        Linear
                    </label>
                </div>
            </div>
            <div class="col-3">
                <h5>Prediction Points</h5>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <button class="btn btn-secondary" type="button" id="button-addon1">-</button>
                    </div>
                    <input type="text" class="form-control text-center" value="2" style="max-width: 5rem">
                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="button" id="button-addon2">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- death-to-recovery chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">What is the death-to-recovery ratio?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="death_to_recovery_chart_mode" value="new_case" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="death_to_recovery_chart_mode" value="cumulative" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="death_to_recovery_chart" class="px-5 mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12 d-flex justify-content-center">
                <div>
                    <h5>Region</h5>
                    <select name="" id="death_to_recovery_chart_region" class="form-control">
                        <option value="China">China</option>
                        <option value="Macau">Macau</option>
                        <option value="Hong Kong">Hong Kong</option>
                        <option value="Taiwan" selected>Taiwan</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- region-comparison chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">How do these regions compare?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="mode" id="new_case3" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="mode" id="cumulative3" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="region_comparison_chart" class="px-5 mt-3"></canvas>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-4">
                <h5>Region 1</h5>
                <select name="" id="" class="form-control">
                    <option value="china">China</option>
                    <option value="macau" selected>Macau</option>
                    <option value="hong_kong">Hong Kong</option>
                    <option value="taiwan">Taiwan</option>
                </select>
            </div>
            <div class="col-4">
                <h5>Region 2</h5>
                <select name="" id="" class="form-control">
                    <option value="china">China</option>
                    <option value="macau">Macau</option>
                    <option value="hong_kong" selected>Hong Kong</option>
                    <option value="taiwan">Taiwan</option>
                </select>
            </div>
            <div class="col-4">
                <h5>Region 3</h5>
                <select name="" id="" class="form-control">
                    <option value="china">China</option>
                    <option value="macau">Macau</option>
                    <option value="hong_kong">Hong Kong</option>
                    <option value="taiwan" selected>Taiwan</option>
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12 d-flex justify-content-center">
                <div>
                    <h5>Case Type</h5>
                    <select name="" id="" class="form-control">
                        <option value="1">comfirmed</option>
                        <option value="2">suspected</option>
                        <option value="3">dead</option>
                        <option value="4">recovered</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- percentage chart -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <h2 class="mt-3">How many of them are from China?</h2>
                <div class="btn-group btn-group-toggle mt-3" data-toggle="buttons">
                    <label class="btn btn-light active">
                        <input type="radio" name="mode" id="new_case4" autocomplete="off"> new case
                    </label>
                    <label class="btn btn-light">
                        <input type="radio" name="mode" id="cumulative4" autocomplete="off" checked> cumulative
                    </label>
                </div>
                <div>
                    <canvas id="percentage_chart" class="px-5 mt-3"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script src="data.js"></script>
    <script>
        ///////////// helper functions /////////////////////////////////////
        
        function delta(array) {
            let result = [];
            for (let i = 0; i < array.length - 1; i++) {
                result[i] = array[i+1] - array[i];
            }
            return result;
        }

        ///////////// trend_chart /////////////////////////////////////

        // let trendChartContext = document.getElementById("trend_chart").getContext("2d");
        // let trendChart = new Chart(trendChartContext, { type: "line", data: chartData, options: chartOptions });
        

        ///////////// death_to_recovery_chart /////////////////////////////////////

        // onload:
        let deathToRecoveryChart = drawDeathToRecoveryChart();

        // on "new case"/"cumulative" clicked:
        $("input[name='death_to_recovery_chart_mode']").on("click", function() {
            deathToRecoveryChart.destroy();
            deathToRecoveryChart = drawDeathToRecoveryChart();
        });

        // on region selected:
        $("#death_to_recovery_chart_region").on("change", function() {
            deathToRecoveryChart.destroy();
            deathToRecoveryChart = drawDeathToRecoveryChart();
        });


        function drawDeathToRecoveryChart() {
            
            let region = $("#death_to_recovery_chart_region").val();
            let mode = $("input[name='death_to_recovery_chart_mode']:checked").val();
            let timeSeries = getTimeSeries(region, mode);

            let context = $("#death_to_recovery_chart")[0].getContext("2d");

            return new Chart(context, { 
                type: "line", 
                data: {
                    labels: timeSeries.time,
                    datasets: [{
                        label: "confirmed",
                        backgroundColor: "#f44336",
                        borderColor: "#f44336",
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        showLine: false,
                        data: timeSeries.confirmed,
                        // hidden: true
                    }, {
                        label: "recovered",
                        backgroundColor: "#64dd17",
                        borderColor: "#64dd17",
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        showLine: false,
                        data: timeSeries.recovered
                    }, {
                        label: "death",
                        backgroundColor: "#424242",
                        borderColor: "#424242",
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        showLine: false,
                        data: timeSeries.death
                    }]
                }, 
                options: {
                    legend: {
                        position: "right"
                    },
                    scales: {
                        xAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                        yAxes: [{
                            ticks: {
                                min: 0
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Number of Person'
                            }
                        }]
                    },
                }
            });
        }

        function getTimeSeries(region, mode) {
            if (mode !== "new_case" && mode !== "cumulative") {
                throw "The mode requested is neither new_case nor cumulative.";
            }

            let timeSeries = {};
            timeSeries.time = data.time;
            timeSeries.confirmed = data.case.find(x => x.region === region).confirmed;
            timeSeries.recovered = data.case.find(x => x.region === region).recovered;
            timeSeries.death = data.case.find(x => x.region === region).death;
            // TODO: what if the region / case type is not found?

            if (mode === "new_case") {
                timeSeries.time = timeSeries.time.slice(1);  // remove first value
                timeSeries.confirmed = delta(timeSeries.confirmed);
                timeSeries.recovered = delta(timeSeries.recovered);
                timeSeries.death = delta(timeSeries.death);
            }

            return timeSeries;
        }

        ///////////// region_comparison_chart /////////////////////////////////////

        // let regionComparisonChartContext = document.getElementById("region_comparison_chart").getContext("2d");
        // let regionComparisonChart = new Chart(regionComparisonChartContext, { type: "line", data: chartData, options: chartOptions });

        ///////////// percentage_chart /////////////////////////////////////

        // let percentageChartContext = document.getElementById("percentage_chart").getContext("2d");
        // let percentageChart = new Chart(percentageChartContext, { type: "line", data: chartData, options: chartOptions });



        // this.chart.getDatasetMeta(legendItem.datasetIndex).hidden = true
        // this.chart.update()
        // see   https://codepen.io/jordanwillis/pen/BWKKKo?editors=0010

    </script>
</body>

</html>